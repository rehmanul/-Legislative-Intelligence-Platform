<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Markdown Review Viewer - Interactive Checkboxes</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
        :root {
          /* ============================================
             COLOR TOKENS - Primary & Status
             ============================================ */
          
          /* Primary Colors */
          --color-primary: #3b82f6;
          --color-primary-hover: #2563eb;
          --color-primary-light: #dbeafe;
          --color-primary-dark: #1e40af;
          
          /* Status Colors */
          --color-success: #10b981;
          --color-success-hover: #059669;
          --color-success-light: #d1fae5;
          --color-success-dark: #065f46;
          
          --color-warning: #f59e0b;
          --color-warning-hover: #d97706;
          --color-warning-light: #fef3c7;
          --color-warning-dark: #92400e;
          
          --color-error: #ef4444;
          --color-error-hover: #dc2626;
          --color-error-light: #fee2e2;
          --color-error-dark: #991b1b;
          
          --color-info: #3b82f6;
          --color-info-hover: #2563eb;
          --color-info-light: #dbeafe;
          --color-info-dark: #1e40af;
          
          /* ============================================
             COLOR TOKENS - Legislative States
             ============================================ */
          
          --color-state-pre-evt: #3b82f6;
          --color-state-pre-evt-light: #dbeafe;
          --color-state-intro-evt: #10b981;
          --color-state-intro-evt-light: #d1fae5;
          --color-state-comm-evt: #f59e0b;
          --color-state-comm-evt-light: #fef3c7;
          --color-state-floor-evt: #ef4444;
          --color-state-floor-evt-light: #fee2e2;
          --color-state-final-evt: #8b5cf6;
          --color-state-final-evt-light: #ede9fe;
          --color-state-impl-evt: #6b7280;
          --color-state-impl-evt-light: #f3f4f6;
          
          /* ============================================
             COLOR TOKENS - Agent Types
             ============================================ */
          
          --color-agent-intelligence: #3b82f6;
          --color-agent-intelligence-bg: #dbeafe;
          --color-agent-drafting: #f59e0b;
          --color-agent-drafting-bg: #fef3c7;
          --color-agent-execution: #ef4444;
          --color-agent-execution-bg: #fee2e2;
          --color-agent-learning: #10b981;
          --color-agent-learning-bg: #d1fae5;
          
          /* ============================================
             COLOR TOKENS - Agent Status
             ============================================ */
          
          --color-status-running: #3b82f6;
          --color-status-running-bg: #dbeafe;
          --color-status-idle: #6b7280;
          --color-status-idle-bg: #e5e7eb;
          --color-status-waiting: #f59e0b;
          --color-status-waiting-bg: #fef3c7;
          --color-status-blocked: #ef4444;
          --color-status-blocked-bg: #fee2e2;
          --color-status-terminated: #6b7280;
          --color-status-terminated-bg: #f3f4f6;
          
          /* ============================================
             COLOR TOKENS - Neutral Colors
             ============================================ */
          
          --color-gray-50: #f9fafb;
          --color-gray-100: #f3f4f6;
          --color-gray-200: #e5e7eb;
          --color-gray-300: #d1d5db;
          --color-gray-400: #9ca3af;
          --color-gray-500: #6b7280;
          --color-gray-600: #4b5563;
          --color-gray-700: #374151;
          --color-gray-800: #1f2937;
          --color-gray-900: #111827;
          
          /* Semantic Neutral Colors */
          --color-bg-primary: #ffffff;
          --color-bg-secondary: #f5f5f5;
          --color-bg-tertiary: #f9fafb;
          --color-text-primary: #1a1a1a;
          --color-text-secondary: #6b7280;
          --color-text-tertiary: #9ca3af;
          --color-border: #e5e7eb;
          --color-border-light: #f3f4f6;
          --color-border-dark: #d1d5db;
          
          /* ============================================
             TYPOGRAPHY TOKENS
             ============================================ */
          
          /* Font Families */
          --font-family-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
          --font-family-mono: 'Courier New', monospace;
          
          /* Font Sizes */
          --font-size-xs: 0.75rem;    /* 12px */
          --font-size-sm: 0.875rem;   /* 14px */
          --font-size-base: 1rem;     /* 16px */
          --font-size-lg: 1.125rem;   /* 18px */
          --font-size-xl: 1.25rem;   /* 20px */
          --font-size-2xl: 1.5rem;   /* 24px */
          --font-size-3xl: 1.875rem; /* 30px */
          --font-size-4xl: 2.25rem;  /* 36px */
          
          /* Font Weights */
          --font-weight-normal: 400;
          --font-weight-medium: 500;
          --font-weight-semibold: 600;
          --font-weight-bold: 700;
          
          /* Line Heights */
          --line-height-tight: 1.25;
          --line-height-normal: 1.5;
          --line-height-relaxed: 1.75;
          
          /* ============================================
             SPACING TOKENS
             ============================================ */
          
          /* Base Unit: 0.25rem (4px) */
          --spacing-xs: 0.25rem;   /* 4px */
          --spacing-sm: 0.5rem;    /* 8px */
          --spacing-md: 1rem;      /* 16px */
          --spacing-lg: 1.5rem;    /* 24px */
          --spacing-xl: 2rem;      /* 32px */
          --spacing-2xl: 3rem;     /* 48px */
          --spacing-3xl: 4rem;     /* 64px */
          
          /* ============================================
             BORDER RADIUS TOKENS
             ============================================ */
          
          --radius-sm: 4px;
          --radius-md: 6px;
          --radius-lg: 8px;
          --radius-xl: 12px;
          --radius-2xl: 16px;
          --radius-full: 9999px;   /* For pills/badges */
          
          /* ============================================
             SHADOW TOKENS (Elevation)
             ============================================ */
          
          --shadow-0: none;
          --shadow-1: 0 1px 2px rgba(0, 0, 0, 0.05);
          --shadow-2: 0 2px 4px rgba(0, 0, 0, 0.1);
          --shadow-3: 0 4px 8px rgba(0, 0, 0, 0.15);
          --shadow-4: 0 8px 16px rgba(0, 0, 0, 0.2);
          --shadow-5: 0 16px 32px rgba(0, 0, 0, 0.25);
          
          /* ============================================
             LAYOUT TOKENS
             ============================================ */
          
          --container-max-width: 1400px;
          --container-max-width-wide: 1600px;
          --container-padding: 2rem;
          
          /* ============================================
             TRANSITION TOKENS
             ============================================ */
          
          --transition-fast: 0.15s;
          --transition-base: 0.2s;
          --transition-slow: 0.3s;
          --transition-ease: ease;
        }




    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.6;
      color: var(--color-text-primary);
      background: var(--color-bg-secondary);
      padding: var(--spacing-xl);
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      background: var(--color-bg-primary);
      padding: var(--spacing-xl);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-xl);
      box-shadow: var(--shadow-2);
    }
    
    h1 {
      font-size: var(--font-size-2xl);
      margin-bottom: var(--spacing-md);
    }
    
    .file-input-wrapper {
      margin: var(--spacing-lg) 0;
    }
    
    .file-input-wrapper label {
      display: inline-block;
      padding: var(--spacing-md) 20px;
      background: var(--color-primary);
      color: var(--color-bg-primary);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: var(--font-size-sm);
    }
    
    .file-input-wrapper input[type="file"] {
      display: none;
    }
    
    .loaded-file {
      margin-left: 15px;
      color: var(--color-text-secondary);
      font-size: 13px;
    }
    
    .context-dropdown-wrapper {
      display: flex;
      gap: var(--spacing-md);
      align-items: center;
      margin-top: var(--spacing-lg);
      flex-wrap: wrap;
    }
    
    .context-dropdown-wrapper label {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      color: var(--color-text-primary);
    }
    
    .context-dropdown-wrapper select {
      padding: var(--spacing-sm) 12px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-sm);
      background: var(--color-bg-primary);
      min-width: 250px;
      cursor: pointer;
    }
    
    .context-dropdown-wrapper button {
      padding: var(--spacing-sm) 16px;
      background: var(--color-gray-500);
      color: var(--color-bg-primary);
      border: none;
      border-radius: var(--radius-sm);
      font-size: var(--font-size-sm);
      cursor: pointer;
      transition: background var(--transition-base) var(--transition-ease);
    }
    
    .context-dropdown-wrapper button:hover {
      background: var(--color-gray-600);
    }
    
    .status-message {
      padding: var(--spacing-md) 15px;
      border-radius: var(--radius-sm);
      margin-top: var(--spacing-md);
      font-size: 13px;
      display: none;
    }
    
    .status-message.success {
      background: #d1e7dd;
      color: #0f5132;
      border: 1px solid #badbcc;
      display: block;
    }
    
    .status-message.error {
      background: #f8d7da;
      color: #842029;
      border: 1px solid #f5c2c7;
      display: block;
    }
    
    .status-message.info {
      background: #cfe2ff;
      color: #084298;
      border: 1px solid #b6d4fe;
      display: block;
    }
    
    .markdown-viewer {
      background: var(--color-bg-primary);
      padding: 30px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-2);
      min-height: 400px;
    }
    
    .markdown-viewer h1,
    .markdown-viewer h2,
    .markdown-viewer h3,
    .markdown-viewer h4 {
      margin-top: 1.5em;
      margin-bottom: 0.5em;
      color: var(--color-text-primary);
      font-weight: var(--font-weight-semibold);
    }
    
    .markdown-viewer h1 {
      font-size: 2em;
      border-bottom: 2px solid var(--color-border);
      padding-bottom: 0.3em;
    }
    
    .markdown-viewer h2 {
      font-size: 1.5em;
      border-bottom: 1px solid var(--color-border);
      padding-bottom: 0.3em;
    }
    
    .markdown-viewer code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: var(--font-family-mono);
      font-size: 0.9em;
      color: #e83e8c;
    }
    
    .markdown-viewer pre {
      background: #f4f4f4;
      padding: var(--spacing-lg);
      border-radius: var(--radius-sm);
      overflow-x: auto;
      margin: var(--spacing-lg) 0;
      border-left: 4px solid var(--color-primary);
    }
    
    .markdown-viewer pre code {
      background: transparent;
      padding: 0;
      color: var(--color-text-primary);
    }
    
    .markdown-viewer blockquote {
      border-left: 4px solid var(--color-primary);
      padding-left: 15px;
      margin: var(--spacing-lg) 0;
      color: var(--color-text-secondary);
      font-style: italic;
    }
    
    .markdown-viewer table {
      width: 100%;
      border-collapse: collapse;
      margin: var(--spacing-lg) 0;
    }
    
    .markdown-viewer table th,
    .markdown-viewer table td {
      padding: var(--spacing-md);
      border: 1px solid var(--color-border);
      text-align: left;
    }
    
    .markdown-viewer table th {
      background: var(--color-gray-100);
      font-weight: var(--font-weight-semibold);
    }
    
    .markdown-viewer ul,
    .markdown-viewer ol {
      margin-left: 30px;
      margin-top: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }
    
    .markdown-viewer li {
      margin-bottom: 5px;
    }
    
    .markdown-viewer p {
      margin-bottom: var(--spacing-lg);
    }
    
    .markdown-viewer hr {
      border: none;
      border-top: 2px solid var(--color-border);
      margin: 30px 0;
    }
    
    .markdown-viewer strong {
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-primary);
    }
    
    .markdown-viewer em {
      font-style: italic;
    }
    
    .todo-checkbox {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: var(--spacing-md);
      margin: 8px 0;
      border-radius: var(--radius-md);
      transition: all var(--transition-base) var(--transition-ease);
      background: var(--color-gray-100);
      border: 1px solid var(--color-border);
    }
    
    .todo-checkbox:hover {
      background: var(--color-border-light);
      border-color: var(--color-primary);
    }
    
    .todo-checkbox.completed {
      background: #d4edda;
      border-color: var(--color-success);
    }
    
    .todo-checkbox input[type="checkbox"] {
      margin-top: 4px;
      width: 20px;
      height: 20px;
      cursor: pointer;
      flex-shrink: 0;
      accent-color: var(--color-success);
    }
    
    .todo-checkbox label {
      flex: 1;
      cursor: pointer;
      margin: 0;
      line-height: 1.5;
    }
    
    .todo-checkbox.completed label {
      text-decoration: line-through;
      color: var(--color-gray-500);
    }
    
    .save-section {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px solid var(--color-border);
      display: flex;
      gap: var(--spacing-md);
      align-items: center;
    }
    
    .save-checkboxes-btn {
      padding: var(--spacing-md) 20px;
      background: var(--color-success);
      color: var(--color-bg-primary);
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      transition: background var(--transition-base) var(--transition-ease);
    }
    
    .save-checkboxes-btn:hover {
      background: #218838;
    }
    
    .save-checkboxes-btn.saved {
      background: var(--color-gray-500);
    }
    
    .save-status {
      font-size: 13px;
      color: var(--color-text-secondary);
    }
    
    .save-status.saved {
      color: var(--color-success);
      font-weight: var(--font-weight-semibold);
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    
    .status-badge {
      display: inline-block;
      padding: var(--spacing-sm) 12px;
      border-radius: var(--radius-xl);
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-semibold);
      margin-left: 10px;
    }
    
    .status-badge.action-required {
      background: #f8d7da;
      color: #721c24;
      animation: pulse 2s infinite;
    }
    
    .status-badge.draft {
      background: #fff3cd;
      color: #856404;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .action-required-section {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: var(--spacing-lg);
      border-radius: var(--radius-sm);
      margin: var(--spacing-xl) 0;
    }
    
    .stats {
      display: flex;
      gap: var(--spacing-xl);
      margin: var(--spacing-xl) 0;
      padding: var(--spacing-lg);
      background: #e7f3ff;
      border-radius: var(--radius-md);
    }
    
    .stat {
      text-align: center;
    }
    
    .stat-value {
      font-size: var(--font-size-2xl);
      font-weight: var(--font-weight-semibold);
      color: var(--color-primary);
    }
    
    .stat-label {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
      text-transform: uppercase;
      margin-top: 5px;
    }
    
    /* Vibe Check Styles */
    .vibe-check-section {
      margin-top: 30px;
      padding: var(--spacing-xl);
      background: #fff9e6;
      border: 2px solid #ffc107;
      border-radius: var(--radius-lg);
    }
    
    .vibe-check-section h2 {
      font-size: var(--font-size-lg);
      margin-bottom: var(--spacing-md);
      color: #856404;
    }
    
    .vibe-check-section details summary {
      cursor: pointer;
      font-weight: var(--font-weight-semibold);
      color: #856404;
      padding: var(--spacing-sm);
      background: var(--color-bg-primary);
      border-radius: var(--radius-sm);
      transition: background var(--transition-base) var(--transition-ease);
    }
    
    .vibe-check-section details summary:hover {
      background: #fffbf0;
    }
    
    .ai-interpretation {
      margin-top: var(--spacing-lg);
      padding: var(--spacing-lg);
      background: #e7f3ff;
      border-left: 4px solid var(--color-primary);
      border-radius: var(--radius-sm);
    }
  </style>
<link rel="stylesheet" href="../../dashboards/shared/dashboard-design-system.css">

</head>
<body>
  
    <!-- Navigation Component -->
    <nav class="dashboard-nav">
        <a href="unified_dashboard.html" class="dashboard-nav__logo">Dashboard Index</a>
        <ul class="dashboard-nav__links">
            <li><a href="unified_dashboard.html" class="dashboard-nav__link--unified ">All Dashboards</a></li>
            <li><a href="../agent-orchestrator/dashboards/dashboard_index.html" class="dashboard-nav__link">Agent Orchestrator</a></li>
            <li><a href="../agent-orchestrator/dashboards/operator_modes_viewer.html" class="dashboard-nav__link">Operator Modes</a></li>
            <li><a href="session_artifact_review.html" class="dashboard-nav__link">Artifact Review</a></li>
        </ul>
    </nav>

<div class="container">
    <header>
      <h1>Markdown Review Viewer</h1>
      <p style="color: var(--color-text-secondary); margin-top: 5px;">View markdown files with interactive checkboxes for TODOs and action items</p>
      
      <div class="context-dropdown-wrapper">
        <label for="markdownDropdown">üìã Quick Load:</label>
        <select id="markdownDropdown" onchange="loadMarkdownFromDropdown(this.value)">
          <option value="">Select markdown file...</option>
          <optgroup label="Recent Files" id="markdownRecentFilesGroup">
            <!-- Populated from localStorage -->
          </optgroup>
        </select>
        <button onclick="refreshMarkdownDropdown()">üîÑ Refresh</button>
      </div>
      <div class="file-input-wrapper">
        <label for="markdownFile">üìÅ Load Markdown File</label>
        <input type="file" id="markdownFile" accept=".md">
        <span id="loadedFile" class="loaded-file"></span>
      </div>
      <div id="statusMessage" class="status-message"></div>
      
      <div id="stats" class="stats" style="display: none;">
        <div class="stat">
          <div class="stat-value" id="totalTodos">0</div>
          <div class="stat-label">Total TODOs</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="completedTodos">0</div>
          <div class="stat-label">Completed</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="remainingTodos">0</div>
          <div class="stat-label">Remaining</div>
        </div>
      </div>
    </header>
    
    <div id="markdownViewer" class="markdown-viewer">
      <div class="empty-state">
        <p>Load a markdown file to view it with interactive checkboxes.</p>
        <p style="margin-top: var(--spacing-md); font-size: var(--font-size-xs); color: #999;">
          Files are typically located in: <code>agent-orchestrator/artifacts/review/*.md</code>
        </p>
      </div>
    </div>
  </div>
  
  <script>
    let markdownCheckboxes = {};
    let currentFileName = null;
    let checkboxMap = [];
    
    // Auto-load on page load
    window.addEventListener('DOMContentLoaded', function() {
      populateRecentMarkdownFiles();
      autoLoadMarkdown();
    });
    
    // Populate recent files dropdown
    function populateRecentMarkdownFiles() {
      const group = document.getElementById('markdownRecentFilesGroup');
      if (!group) return;
      
      try {
        const recent = JSON.parse(localStorage.getItem('recentMarkdownFiles') || '[]');
        group.innerHTML = '';
        
        recent.slice(0, 10).forEach(file => {
          const option = document.createElement('option');
          option.value = file.path;
          option.textContent = file.name + ' (Recent)';
          group.appendChild(option);
        });
      } catch (e) {
        console.warn('Could not load recent markdown files:', e);
      }
    }
    
    // Auto-load markdown
    async function autoLoadMarkdown() {
      const lastPath = localStorage.getItem('lastSuccessfulMarkdownPath');
      if (lastPath) {
        try {
          const response = await fetch(lastPath);
          if (response.ok) {
            const content = await response.text();
            currentFileName = lastPath.split('/').pop();
            document.getElementById('loadedFile').textContent = `Loaded: ${currentFileName}`;
            renderMarkdown(content, currentFileName);
            showStatus('Auto-loaded: ' + currentFileName, 'success');
            return;
          }
        } catch (e) {
          // Continue
        }
      }
    }
    
    // Load from dropdown
    async function loadMarkdownFromDropdown(path) {
      if (!path) return;
      
      showStatus('Loading ' + path + '...', 'info');
      
      try {
        const response = await fetch(path);
        if (response.ok) {
          const content = await response.text();
          currentFileName = path.split('/').pop();
          document.getElementById('loadedFile').textContent = `Loaded: ${currentFileName}`;
          localStorage.setItem('lastSuccessfulMarkdownPath', path);
          addToRecentMarkdownFiles(path);
          renderMarkdown(content, currentFileName);
          showStatus('Loaded: ' + currentFileName, 'success');
        } else {
          showStatus('Could not load ' + path, 'error');
        }
      } catch (e) {
        showStatus('Error loading ' + path + ': ' + e.message, 'error');
      }
    }
    
    // Refresh dropdown
    function refreshMarkdownDropdown() {
      populateRecentMarkdownFiles();
      showStatus('Dropdown refreshed', 'info');
      setTimeout(() => {
        const msg = document.getElementById('statusMessage');
        if (msg) msg.className = 'status-message';
      }, 2000);
    }
    
    // Add to recent files
    function addToRecentMarkdownFiles(path) {
      try {
        const recent = JSON.parse(localStorage.getItem('recentMarkdownFiles') || '[]');
        const name = path.split('/').pop();
        const filtered = recent.filter(f => f.path !== path);
        filtered.unshift({ name, path, timestamp: new Date().toISOString() });
        localStorage.setItem('recentMarkdownFiles', JSON.stringify(filtered.slice(0, 10)));
        populateRecentMarkdownFiles();
      } catch (e) {
        console.warn('Could not save recent markdown files:', e);
      }
    }
    
    // Show status
    function showStatus(message, type) {
      const msg = document.getElementById('statusMessage');
      if (!msg) return;
      msg.textContent = message;
      msg.className = 'status-message ' + type;
      if (type === 'success' || type === 'info') {
        setTimeout(() => {
          msg.className = 'status-message';
        }, 5000);
      }
    }
    
    // Load saved checkbox state from localStorage
    function loadCheckboxState(fileName) {
      try {
        const key = 'md-checkboxes-' + fileName;
        const saved = localStorage.getItem(key);
        if (saved) {
          const savedState = JSON.parse(saved);
          Object.keys(savedState).forEach(id => {
            markdownCheckboxes[id] = savedState[id];
            const checkbox = document.getElementById(id);
            const container = document.getElementById('todo-' + id);
            if (checkbox && container) {
              checkbox.checked = savedState[id];
              if (savedState[id]) {
                container.classList.add('completed');
              } else {
                container.classList.remove('completed');
              }
            }
          });
          updateStats();
        }
      } catch (e) {
        console.warn('Could not load checkbox state:', e);
      }
    }
    
    // Save checkbox state to localStorage
    function saveCheckboxState(fileName) {
      try {
        const key = 'md-checkboxes-' + fileName;
        localStorage.setItem(key, JSON.stringify(markdownCheckboxes));
        
        const saveBtn = document.getElementById('saveBtn');
        const saveStatus = document.getElementById('saveStatus');
        
        if (saveBtn) {
          saveBtn.classList.add('saved');
          saveBtn.textContent = '‚úì Saved';
          setTimeout(() => {
            saveBtn.classList.remove('saved');
            saveBtn.textContent = 'üíæ Save Checkbox State';
          }, 2000);
        }
        
        if (saveStatus) {
          saveStatus.textContent = 'Last saved: ' + new Date().toLocaleTimeString();
          saveStatus.classList.add('saved');
        }
        
        updateStats();
      } catch (e) {
        console.warn('Could not save checkbox state:', e);
        alert('Could not save checkbox state: ' + e.message);
      }
    }
    
    // Toggle checkbox state
    function toggleTodo(checkboxId) {
      const checkbox = document.getElementById(checkboxId);
      const container = document.getElementById('todo-' + checkboxId);
      
      if (!checkbox || !container) return;
      
      if (checkbox.checked) {
        container.classList.add('completed');
        markdownCheckboxes[checkboxId] = true;
      } else {
        container.classList.remove('completed');
        markdownCheckboxes[checkboxId] = false;
      }
      
      updateStats();
      
      // Auto-save
      if (currentFileName) {
        saveCheckboxState(currentFileName);
      }
    }
    
    // Update statistics
    function updateStats() {
      const total = checkboxMap.length;
      const completed = Object.values(markdownCheckboxes).filter(v => v === true).length;
      const remaining = total - completed;
      
      const totalEl = document.getElementById('totalTodos');
      const completedEl = document.getElementById('completedTodos');
      const remainingEl = document.getElementById('remainingTodos');
      
      if (totalEl) totalEl.textContent = total;
      if (completedEl) completedEl.textContent = completed;
      if (remainingEl) remainingEl.textContent = remaining;
      
      if (total > 0) {
        document.getElementById('stats').style.display = 'flex';
      }
    }
    
    // File input handler
    document.getElementById('markdownFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        loadMarkdown(file);
      }
    });
    
    // Load and render markdown file
    function loadMarkdown(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const content = e.target.result;
        currentFileName = file.name;
        document.getElementById('loadedFile').textContent = `Loaded: ${file.name}`;
        localStorage.setItem('lastSuccessfulMarkdownPath', file.name);
        addToRecentMarkdownFiles(file.name);
        renderMarkdown(content, file.name);
        showStatus('Loaded: ' + file.name, 'success');
      };
      reader.readAsText(file);
    }
    
    // Anti-flash rendering for markdown
    function renderMarkdown(content, fileName) {
      const viewer = document.getElementById('markdownViewer');
      
      // Hide during update
      viewer.style.visibility = 'hidden';
      viewer.style.opacity = '0';
      viewer.style.transition = 'opacity 0.2s';
      
      // Process markdown
      const checkboxId = 'cb-' + Date.now();
      let checkboxCounter = 0;
      checkboxMap = [];
      markdownCheckboxes = {};
      
      window.currentMarkdownContent = content;
      window.currentMarkdownFileName = fileName;
      
      const lines = content.split('\n');
      const processedLines = [];
      
      lines.forEach((line, index) => {
        const checkboxMatch = line.match(/^(\s*)- \[([ xX])\](.*)$/i);
        if (checkboxMatch) {
          const indent = checkboxMatch[1];
          const checked = checkboxMatch[2].toLowerCase() === 'x';
          const text = checkboxMatch[3].trim();
          const id = `${checkboxId}-${checkboxCounter++}`;
          
          checkboxMap.push({
            id: id,
            originalLine: line,
            index: index,
            text: text,
            checked: checked
          });
          
          processedLines.push(`${indent}<!--CHECKBOX:${id}:${checked}:${text}-->`);
        } else {
          processedLines.push(line);
        }
      });
      
      const html = marked.parse(processedLines.join('\n'));
      
      let finalHtml = html;
      checkboxMap.forEach(cb => {
        const placeholder = `<!--CHECKBOX:${cb.id}:${cb.checked}:${cb.text}-->`;
        const checkboxHtml = `
          <div class="todo-checkbox ${cb.checked ? 'completed' : ''}" id="todo-${cb.id}">
            <input type="checkbox" id="${cb.id}" ${cb.checked ? 'checked' : ''} onchange="toggleTodo('${cb.id}')">
            <label for="${cb.id}">${cb.text}</label>
          </div>
        `;
        finalHtml = finalHtml.replace(placeholder, checkboxHtml);
        
        if (cb.checked) {
          markdownCheckboxes[cb.id] = true;
        } else {
          markdownCheckboxes[cb.id] = false;
        }
      });
      
      // Check for ACTION_REQUIRED or DRAFT status
      const actionRequired = content.match(/STATUS.*ACTION_REQUIRED|ACTION.*REQUIRED/gi);
      const draftStatus = content.match(/STATUS.*DRAFT|DRAFT.*STATUS/gi);
      
      let statusHtml = '';
      if (actionRequired) {
        statusHtml = `
          <div class="action-required-section">
            <strong>‚ö†Ô∏è ACTION REQUIRED</strong> - This document requires immediate attention.
          </div>
        `;
      } else if (draftStatus) {
        statusHtml = `
          <div class="action-required-section" style="background: #fff3cd; border-left-color: #ffc107;">
            <strong>üìù DRAFT STATUS</strong> - This document is in draft form and may require review.
          </div>
        `;
      }
      
      // Update in one operation with anti-flash
      requestAnimationFrame(() => {
        viewer.innerHTML = statusHtml + finalHtml + `
          <div class="save-section">
            <button class="save-checkboxes-btn" id="saveBtn" onclick="saveCheckboxState('${fileName}')">
              üíæ Save Checkbox State
            </button>
            <span id="saveStatus" class="save-status"></span>
          </div>
        `;
        loadCheckboxState(fileName);
        updateStats();
        viewer.style.visibility = 'visible';
        viewer.style.opacity = '1';
      });
    }
    
    // Configure marked.js options
    marked.setOptions({
      breaks: true,
      gfm: true,
      headerIds: true,
      mangle: false
    });
  </script>
</body>
</html>